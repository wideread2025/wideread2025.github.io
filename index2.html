<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WideRead - 论文阅读平台</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
      /* 响应式布局 */
      @media (max-width: 992px) {
        .sidebar-container {
          position: fixed;
          top: 0;
          left: -300px;
          width: 280px;
          height: 100%;
          background: white;
          box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
          transition: left 0.3s ease;
          z-index: 1000;
          overflow-y: auto;
        }

        .sidebar-container.active {
          left: 0;
        }

        .main-content {
          margin-left: 0;
          padding: 10px;
        }

        .filter-container {
          flex-direction: column;
          gap: 10px;
        }

        .filter-row {
          flex-direction: column;
          gap: 10px;
        }

        .search-container {
          width: 100%;
        }

        .filter-group {
          width: 100%;
        }

        .time-filter-buttons {
          flex-wrap: wrap;
          justify-content: flex-start;
        }

        .time-filter-btn {
          margin: 2px;
        }

        .filter-stats {
          width: 100%;
          text-align: center;
        }

        .paper-card {
          padding: 12px;
        }

        .paper-meta span {
          display: block;
          margin-bottom: 4px;
        }

        .paper-keywords {
          gap: 4px;
        }

        .keyword-tag {
          font-size: 12px;
          padding: 2px 6px;
        }

        .modal-content {
          width: 95%;
          max-height: 95vh;
        }
      }

      @media (max-width: 600px) {
        .sidebar-container {
          width: 100%;
          left: -100%;
        }

        .paper-card {
          padding: 10px;
        }

        .paper-title {
          font-size: 16px;
        }

        .paper-translation {
          font-size: 14px;
        }

        .paper-authors {
          font-size: 12px;
        }

        .paper-keywords {
          flex-wrap: wrap;
        }

        .keyword-tag {
          font-size: 11px;
          padding: 2px 5px;
        }

        .paper-tldr {
          font-size: 12px;
          padding: 8px;
        }
      }

      /* 基础样式 */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }

      .header {
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 16px 20px;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header h1 {
        margin: 0;
        font-size: 24px;
        color: #202124;
      }

      .layout-container {
        display: flex;
        min-height: calc(100vh - 60px);
      }

      /* 侧边栏容器 */
      .sidebar-container {
        width: 300px;
        background: white;
        border-right: 1px solid #e0e0e0;
        padding: 20px;
        overflow-y: auto;
        flex-shrink: 0;
      }

      .sidebar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      }

      .sidebar-header h3 {
        margin: 0;
        font-size: 18px;
        color: #202124;
      }

      .reset-btn {
        background: #f1f3f4;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 14px;
        color: #5f6368;
      }

      .reset-btn:hover {
        background: #e8eaed;
      }

      .sidebar-tags {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .sidebar-tag-item {
        padding: 8px 12px;
        background: #f1f3f4;
        border-radius: 16px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .sidebar-tag-item:hover {
        background: #e8eaed;
      }

      .sidebar-tag-item.active {
        background: #1a73e8;
        color: white;
      }

      .tag-count {
        font-size: 12px;
        background: rgba(0, 0, 0, 0.1);
        padding: 2px 6px;
        border-radius: 10px;
      }

      .sidebar-tag-item.active .tag-count {
        background: rgba(255, 255, 255, 0.3);
      }

      /* 主要内容区域 */
      .main-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
      }

      .filter-container {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }

      .filter-row {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
      }

      .search-container {
        flex: 1;
        min-width: 200px;
      }

      .search-input {
        width: 100%;
        padding: 10px 16px;
        border: 1px solid #dfe1e5;
        border-radius: 24px;
        font-size: 16px;
        outline: none;
        transition: box-shadow 0.2s;
      }

      .search-input:focus {
        box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
        border-color: rgba(223, 225, 229, 0);
      }

      .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .time-filter-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .time-filter-btn {
        padding: 6px 12px;
        border: 1px solid #dadce0;
        background: white;
        border-radius: 16px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .time-filter-btn:hover {
        background: #f8f9fa;
        border-color: #d2e3fc;
      }

      .time-filter-btn.active {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
      }

      .filter-stats {
        font-size: 14px;
        color: #5f6368;
        white-space: nowrap;
      }

      /* 论文卡片 */
      .container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 20px;
      }

      .paper-card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
      }

      .paper-card:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        transform: translateY(-2px);
      }

      .paper-card.read {
        opacity: 0.7;
      }

      .paper-card.read::before {
        content: "✓";
        position: absolute;
        top: 10px;
        right: 10px;
        color: #34a853;
        font-weight: bold;
      }

      .paper-title {
        margin: 0 0 8px 0;
        font-size: 18px;
        font-weight: 500;
        color: #1a0dab;
        line-height: 1.3;
      }

      .paper-translation {
        margin: 0 0 12px 0;
        font-size: 16px;
        color: #5f6368;
        line-height: 1.4;
      }

      .paper-meta {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        font-size: 13px;
        color: #5f6368;
      }

      .paper-meta span {
        display: flex;
        align-items: center;
      }

      .paper-meta span:not(:last-child)::after {
        content: "•";
        margin-left: 12px;
      }

      .paper-authors {
        margin: 0 0 12px 0;
        font-size: 14px;
        color: #5f6368;
      }

      .paper-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin: 12px 0;
      }

      .keyword-tag {
        background: #e8f0fe;
        color: #1a73e8;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 13px;
        white-space: nowrap;
      }

      .paper-tldr {
        background: #f8f9fa;
        border-radius: 6px;
        padding: 12px;
        margin-top: 12px;
        font-size: 14px;
        line-height: 1.5;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #5f6368;
        font-size: 16px;
      }

      /* 分页控件 */
      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
        margin-top: 30px;
        padding: 20px 0;
      }

      .page-btn {
        padding: 8px 16px;
        border: 1px solid #dadce0;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .page-btn:hover:not(.disabled) {
        background: #f8f9fa;
        border-color: #d2e3fc;
      }

      .page-btn.active {
        background: #1a73e8;
        color: white;
        border-color: #1a73e8;
      }

      .page-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* 模态框 */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        overflow-y: auto;
      }

      .modal-content {
        background: white;
        margin: 5% auto;
        padding: 24px;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        position: relative;
        max-height: 90vh;
        overflow-y: auto;
      }

      .close-btn {
        position: absolute;
        top: 16px;
        right: 24px;
        font-size: 28px;
        cursor: pointer;
        color: #5f6368;
      }

      .close-btn:hover {
        color: #202124;
      }

      .details h2 {
        margin: 0 0 16px 0;
        font-size: 24px;
        color: #202124;
      }

      .details h2 a {
        color: #1a0dab;
        text-decoration: none;
      }

      .details h2 a:hover {
        text-decoration: underline;
      }

      .details p {
        margin: 12px 0;
        line-height: 1.6;
        color: #202124;
      }

      .details strong {
        color: #5f6368;
      }

      .details a {
        color: #1a0dab;
        text-decoration: none;
      }

      .details a:hover {
        text-decoration: underline;
      }

      .details pre {
        background: #f1f3f4;
        padding: 16px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 14px;
        line-height: 1.5;
      }

      .details code {
        font-family: "Courier New", monospace;
      }

      .details ul,
      .details ol {
        padding-left: 24px;
        margin: 12px 0;
      }

      .details li {
        margin: 8px 0;
        line-height: 1.5;
      }

      .details blockquote {
        border-left: 4px solid #dadce0;
        padding: 8px 16px;
        margin: 12px 0;
        background: #f8f9fa;
        color: #5f6368;
      }

      .details img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
        margin: 12px 0;
      }

      /* 图标区域 */
      .icons-container {
        display: flex;
        gap: 16px;
        margin-top: 16px;
      }

      .icon-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: background-color 0.2s;
      }

      .icon-item:hover {
        background-color: #f1f3f4;
      }

      .icon-item.active {
        background-color: #e8f0fe;
      }

      .icon-item svg {
        width: 24px;
        height: 24px;
        margin-bottom: 4px;
      }

      .icon-item span {
        font-size: 12px;
        color: #5f6368;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>WideRead - 论文阅读平台</h1>
    </div>

    <div class="layout-container">
      <!-- 侧边栏容器 -->
      <div class="sidebar-container">
        <!-- 关键词侧边栏 -->
        <div class="tags-sidebar" id="tags-sidebar">
          <div class="sidebar-header">
            <h3>关键词筛选</h3>
            <button class="reset-btn" id="reset-tags">重置</button>
          </div>
          <div class="sidebar-tags" id="sidebar-tags-container">
            <!-- 关键词将通过JavaScript动态添加 -->
          </div>
        </div>

        <!-- 期刊侧边栏 -->
        <div class="journal-sidebar" id="journal-sidebar">
          <div class="sidebar-header">
            <h3>期刊筛选</h3>
            <button class="reset-btn" id="reset-journal">重置</button>
          </div>
          <input
            type="text"
            id="journal-search"
            class="filter-search"
            placeholder="搜索期刊..."
            style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;"
          />
          <div class="sidebar-tags" id="journal-tags-container">
            <!-- 期刊标签将通过JavaScript动态添加 -->
          </div>
        </div>

        <!-- 来源侧边栏 -->
        <div class="source-sidebar" id="source-sidebar">
          <div class="sidebar-header">
            <h3>来源筛选</h3>
            <button class="reset-btn" id="reset-source">重置</button>
          </div>
          <input
            type="text"
            id="source-search"
            class="filter-search"
            placeholder="搜索来源..."
            style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;"
          />
          <div class="sidebar-tags" id="source-tags-container">
            <!-- 来源标签将通过JavaScript动态添加 -->
          </div>
        </div>
      </div>

      <!-- 主要内容区域 -->
      <div class="main-content">
        <div class="filter-container">
          <div class="filter-row">
            <div class="search-container">
              <input
                type="text"
                id="search-input"
                class="search-input"
                placeholder="搜索论文标题、关键词或摘要..."
              />
            </div>
            <div class="filter-group">
              <div class="time-filter-buttons" id="time-filter-buttons">
                <button class="time-filter-btn active" data-value="all">
                  全部
                </button>
                <button class="time-filter-btn" data-value="today">今天</button>
                <button class="time-filter-btn" data-value="week">本周</button>
                <button class="time-filter-btn" data-value="month">本月</button>
                <button class="time-filter-btn" data-value="halfyear">
                  半年
                </button>
                <button class="time-filter-btn" data-value="year">今年</button>
                <button class="time-filter-btn" data-value="2years">2年</button>
                <button class="time-filter-btn" data-value="3years">3年</button>
                <button class="time-filter-btn" data-value="5years">5年</button>
              </div>
            </div>
            <div class="filter-stats">共 <span id="papers-count">0</span> 篇</div>
          </div>
        </div>

        <div class="container" id="papers-container"></div>
        
        <!-- 分页控件 -->
        <div class="pagination" id="pagination-container"></div>
      </div>

      <div class="modal" id="paper-modal">
        <div class="modal-content">
          <span class="close-btn" id="close-modal">&times;</span>
          <div id="modal-details" class="details"></div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("papers-container");
        const modal = document.getElementById("paper-modal");
        const modalDetails = document.getElementById("modal-details");
        const closeModal = document.getElementById("close-modal");
        const readPapers = new Set();
        const timeFilterButtons = document.getElementById(
          "time-filter-buttons",
        );
        const sidebarTagsContainer = document.getElementById(
          "sidebar-tags-container",
        );
        const papersCount = document.getElementById("papers-count");
        const searchInput = document.getElementById("search-input");
        const tagsIcon = document.getElementById("tags-icon");
        const journalIcon = document.getElementById("journal-icon");
        const sourceIcon = document.getElementById("source-icon");
        const tagsSidebar = document.getElementById("tags-sidebar");
        const journalSidebar = document.getElementById("journal-sidebar");
        const sourceSidebar = document.getElementById("source-sidebar");
        const resetTagsBtn = document.getElementById("reset-tags");
        const resetJournalBtn = document.getElementById("reset-journal");
        const resetSourceBtn = document.getElementById("reset-source");
        const journalSearch = document.getElementById("journal-search"); // 新增期刊搜索框
        const sourceSearch = document.getElementById("source-search"); // 新增来源搜索框
        const journalTagsContainer = document.getElementById("journal-tags-container"); // 新增期刊标签容器
        const sourceTagsContainer = document.getElementById("source-tags-container"); // 新增来源标签容器
        const paginationContainer = document.getElementById("pagination-container");

        let allPapers = [];
        let filteredPapers = [];
        let selectedTags = new Set();
        let currentTimeFilter = "all";
        let selectedJournals = new Set(); // 修改为Set以支持多选
        let selectedSources = new Set(); // 修改为Set以支持多选，并统一转为小写存储
        
        // 分页相关变量
        const PAPER_PER_PAGE = 60;
        let currentPage = 1;

        // 关闭模态框函数
        function closePaperModal() {
          modal.style.display = "none";
          document.body.style.overflow = "auto";
        }

        // 关闭按钮事件
        closeModal.addEventListener("click", closePaperModal);

        // 点击模态框外部关闭
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closePaperModal();
        });

        // 尝试从localStorage加载已读状态
        const savedRead = localStorage.getItem("readPapers");
        if (savedRead) {
          JSON.parse(savedRead).forEach((index) => readPapers.add(index));
        }

        // 侧边栏交互
        tagsIcon.addEventListener("click", () => {
          tagsSidebar.classList.toggle("active");
          journalSidebar.classList.remove("active");
          sourceSidebar.classList.remove("active");
        });

        journalIcon.addEventListener("click", () => {
          journalSidebar.classList.toggle("active");
          tagsSidebar.classList.remove("active");
          sourceSidebar.classList.remove("active");
        });

        // 来源筛选图标点击事件
        sourceIcon.addEventListener("click", () => {
          sourceSidebar.classList.toggle("active");
          tagsSidebar.classList.remove("active");
          journalSidebar.classList.remove("active");
        });

        // 点击外部关闭侧边栏
        document.addEventListener("click", (e) => {
          if (
            !e.target.closest(".sidebar-container") &&
            !e.target.closest(".tags-sidebar") &&
            !e.target.closest(".journal-sidebar") &&
            !e.target.closest(".source-sidebar")
          ) {
            tagsSidebar.classList.remove("active");
            journalSidebar.classList.remove("active");
            sourceSidebar.classList.remove("active");
          }
        });

        // 重置关键词
        resetTagsBtn.addEventListener("click", () => {
          selectedTags.clear();
          document.querySelectorAll(".sidebar-tag-item").forEach((tag) => {
            tag.classList.remove("active");
          });
          applyAllFilters();
        });

        // 重置期刊
        resetJournalBtn.addEventListener("click", () => {
          selectedJournals.clear();
          updateJournalTags(); // 更新标签显示
          applyAllFilters();
        });

        // 重置来源
        resetSourceBtn.addEventListener("click", () => {
          selectedSources.clear();
          updateSourceTags(); // 更新标签显示
          applyAllFilters();
        });

        // 期刊搜索
        journalSearch.addEventListener("input", () => {
          populateJournalFilter(allPapers);
        });

        // 来源搜索
        sourceSearch.addEventListener("input", () => {
          populateSourceFilter(allPapers);
        });

        // 1. 数据加载函数
        function loadPapersData(jsonUrl) {
          if (window.embeddedPapersData) {
            return Promise.resolve(window.embeddedPapersData).then((papers) => {
              if (!Array.isArray(papers))
                throw new Error("嵌入的论文数据格式不正确");
              return papers;
            });
          } else {
            // 对于GitHub Pages，需要手动处理GZIP解压缩
            const gzipUrl = jsonUrl.endsWith(".json")
              ? jsonUrl + ".gz"
              : jsonUrl;

            return fetch(gzipUrl)
              .then((response) => {
                if (!response.ok) {
                  // 如果.gz文件不存在，回退到原始JSON文件
                  if (response.status === 404 && gzipUrl.endsWith(".gz")) {
                    return fetch(jsonUrl).then((response) => {
                      if (!response.ok)
                        throw new Error(
                          "无法加载论文数据: " + response.statusText,
                        );
                      return response.json();
                    });
                  }
                  throw new Error("无法加载论文数据: " + response.statusText);
                }

                // GitHub Pages返回的是原始GZIP数据，需要手动解压缩
                return response.arrayBuffer().then((buffer) => {
                  // 使用pako库进行GZIP解压缩
                  if (typeof pako === "undefined") {
                    throw new Error("pako库未加载，无法解压缩GZIP文件");
                  }

                  try {
                    const decompressed = pako.inflate(new Uint8Array(buffer), {
                      to: "string",
                    });
                    return JSON.parse(decompressed);
                  } catch (e) {
                    throw new Error("GZIP解压缩失败: " + e.message);
                  }
                });
              })
              .then((papers) => {
                if (!Array.isArray(papers))
                  throw new Error("论文数据格式不正确");
                return papers;
              })
              .catch((error) => {
                console.warn("GZIP加载失败，尝试原始JSON:", error);
                // 回退到原始JSON文件
                return fetch(jsonUrl)
                  .then((response) => {
                    if (!response.ok)
                      throw new Error(
                        "无法加载论文数据: " + response.statusText,
                      );
                    return response.json();
                  })
                  .then((papers) => {
                    if (!Array.isArray(papers))
                      throw new Error("论文数据格式不正确");
                    return papers;
                  });
              });
          }
        }

        // 2. 卡片渲染函数（分页）
        function renderPapersCards(container, papers, page = 1) {
          container.innerHTML = "";
          
          if (papers.length === 0) {
            container.innerHTML = `<div class="loading">没有找到符合条件的论文</div>`;
            renderPagination(0, page);
            return;
          }
          
          // 计算分页数据
          const totalPages = Math.ceil(papers.length / PAPER_PER_PAGE);
          const startIndex = (page - 1) * PAPER_PER_PAGE;
          const endIndex = Math.min(startIndex + PAPER_PER_PAGE, papers.length);
          const papersToShow = papers.slice(startIndex, endIndex);
          
          // 显示加载中状态
          container.innerHTML = `<div class="loading">加载中...</div>`;
          
          // 使用setTimeout让UI有机会更新显示"加载中"
          setTimeout(() => {
            container.innerHTML = "";
            
            papersToShow.forEach((paper, index) => {
              const globalIndex = startIndex + index;
              const card = document.createElement("div");
              card.className = `paper-card ${readPapers.has(globalIndex) ? "read" : ""}`;
              card.dataset.index = globalIndex;

              // 标题
              const title = document.createElement("h3");
              title.className = "paper-title";
              title.textContent = paper.title || "无标题";
              card.appendChild(title);

              // 翻译标题
              if (paper.title_translation) {
                const translation = document.createElement("div");
                translation.className = "paper-translation";
                translation.textContent = paper.title_translation;
                card.appendChild(translation);
              }

              // 元信息
              const meta = document.createElement("div");
              meta.className = "paper-meta";

              if (paper.journal) {
                const journal = document.createElement("span");
                journal.textContent = paper.journal;
                meta.appendChild(journal);
              }

              if (paper.date) {
                const date = document.createElement("span");
                date.textContent = paper.date;
                meta.appendChild(date);
              }

              if (paper.source) {
                const source = document.createElement("span");
                source.textContent = paper.source;
                meta.appendChild(source);
              }

              card.appendChild(meta);

              // 作者
              if (
                paper.authors &&
                Array.isArray(paper.authors) &&
                paper.authors.length > 0
              ) {
                const authors = document.createElement("div");
                authors.className = "paper-authors";
                authors.style.fontSize = "14px";
                authors.style.color = "#666";
                authors.style.marginBottom = "12px";
                authors.textContent = `作者: ${paper.authors.join(", ")}`;
                card.appendChild(authors);
              }

              // AI分析部分
              if (paper.ai) {
                // 关键词
                if (
                  paper.ai.keywords &&
                  Array.isArray(paper.ai.keywords) &&
                  paper.ai.keywords.length > 0
                ) {
                  const keywordsContainer = document.createElement("div");
                  keywordsContainer.className = "paper-keywords";

                  paper.ai.keywords.forEach((keyword) => {
                    const keywordTag = document.createElement("span");
                    keywordTag.className = "keyword-tag";
                    keywordTag.textContent = keyword;
                    keywordsContainer.appendChild(keywordTag);
                  });

                  card.appendChild(keywordsContainer);
                }

                // TLDR
                if (paper.ai.TLDR) {
                  const tldr = document.createElement("div");
                  tldr.className = "paper-tldr";
                  tldr.style.padding = "12px";
                  tldr.style.borderRadius = "6px";
                  tldr.style.marginTop = "12px";
                  tldr.style.fontSize = "14px";
                  tldr.innerHTML = `<strong>简要总结:</strong> ${paper.ai.TLDR}`;
                  card.appendChild(tldr);
                }
              }

              // 添加点击事件
              card.addEventListener("click", () => {
                displayDetails(paper, globalIndex);
                readPapers.add(globalIndex);
                card.classList.add("read");
                localStorage.setItem(
                  "readPapers",
                  JSON.stringify(Array.from(readPapers)),
                );
              });

              container.appendChild(card);
            });
            
            // 渲染分页控件
            renderPagination(totalPages, page);
          }, 0);
        }

        // 3. 渲染分页控件
        function renderPagination(totalPages, currentPage) {
          paginationContainer.innerHTML = "";
          
          if (totalPages <= 1) return;
          
          // 首页按钮
          const firstBtn = document.createElement("button");
          firstBtn.className = `page-btn ${currentPage === 1 ? "disabled" : ""}`;
          firstBtn.textContent = "首页";
          firstBtn.disabled = currentPage === 1;
          firstBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              renderPapersCards(container, filteredPapers, 1);
            }
          });
          paginationContainer.appendChild(firstBtn);
          
          // 上一页按钮
          const prevBtn = document.createElement("button");
          prevBtn.className = `page-btn ${currentPage === 1 ? "disabled" : ""}`;
          prevBtn.textContent = "上一页";
          prevBtn.disabled = currentPage === 1;
          prevBtn.addEventListener("click", () => {
            if (currentPage > 1) {
              renderPapersCards(container, filteredPapers, currentPage - 1);
            }
          });
          paginationContainer.appendChild(prevBtn);
          
          // 页码按钮
          const startPage = Math.max(1, currentPage - 3);
          const endPage = Math.min(totalPages, currentPage + 3);
          
          for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.className = `page-btn ${i === currentPage ? "active" : ""}`;
            pageBtn.textContent = i;
            pageBtn.addEventListener("click", () => {
              renderPapersCards(container, filteredPapers, i);
            });
            paginationContainer.appendChild(pageBtn);
          }
          
          // 下一页按钮
          const nextBtn = document.createElement("button");
          nextBtn.className = `page-btn ${currentPage === totalPages ? "disabled" : ""}`;
          nextBtn.textContent = "下一页";
          nextBtn.disabled = currentPage === totalPages;
          nextBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
              renderPapersCards(container, filteredPapers, currentPage + 1);
            }
          });
          paginationContainer.appendChild(nextBtn);
          
          // 末页按钮
          const lastBtn = document.createElement("button");
          lastBtn.className = `page-btn ${currentPage === totalPages ? "disabled" : ""}`;
          lastBtn.textContent = "末页";
          lastBtn.disabled = currentPage === totalPages;
          lastBtn.addEventListener("click", () => {
            if (currentPage < totalPages) {
              renderPapersCards(container, filteredPapers, totalPages);
            }
          });
          paginationContainer.appendChild(lastBtn);
        }

        // 4. 显示详情函数
        function displayDetails(paper, index) {
          modalDetails.innerHTML = `
                    <h2><a href="${paper.url || "#"}\" target="_blank\" rel=\"noopener\">${paper.title || "无标题"}</a></h2>
                    <p><strong>期刊/日期/作者:</strong> ${paper.journal || "未知"} · ${paper.date || "未知"} · ${paper.authors ? (Array.isArray(paper.authors) ? (paper.authors.length > 0 ? paper.authors.join(", ") : "未知") : typeof paper.authors === "string" ? paper.authors : "未知") : "未知"}</p>
                    <p>
                        ${paper.doi ? `<strong>DOI:</strong> <a href=\"https://doi.org/${paper.doi}\" target=\"_blank\" rel=\"noopener\">${paper.doi}</a>` : ""}
                    </p>
                    ${paper.abstract ? `<p><strong>摘要:</strong></p><p>${paper.abstract}</p>` : ""}
                    ${paper.description ? `<p><strong>描述:</strong></p><p>${paper.description}</p>` : ""}
                    ${paper.title_translation ? `<p><strong>标题翻译:</strong></p><p>${paper.title_translation}</p>` : ""}
                    ${paper.ai?.translation ? `<p><strong>摘要翻译:</strong></p><p>${paper.ai.translation}</p>` : ""}
                    ${paper.ai?.TLDR ? `<p><strong>简要总结:</strong></p><p>${paper.ai.TLDR}</p>` : ""}
                    ${paper.ai?.keywords && Array.isArray(paper.ai.keywords) && paper.ai.keywords.length > 0 ? `<p><strong>关键词:</strong></p><p>${paper.ai.keywords.join(", ")}</p>` : ""}
                `;
          modal.style.display = "block";
          document.body.style.overflow = "hidden"; // 防止背景滚动
        }

        // 5. 提取所有关键词并创建侧边栏标签
        function populateSidebarTags(papers) {
          const keywordsMap = new Map();

          papers.forEach((paper) => {
            if (
              paper.ai &&
              paper.ai.keywords &&
              Array.isArray(paper.ai.keywords)
            ) {
              paper.ai.keywords.forEach((keyword) => {
                if (keyword && keyword.trim()) {
                  keywordsMap.set(keyword, (keywordsMap.get(keyword) || 0) + 1);
                }
              });
            }
          });

          // 将关键词按出现频率排序
          const sortedKeywords = Array.from(keywordsMap.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 100);

          // 清空标签容器
          sidebarTagsContainer.innerHTML = "";

          // 添加到侧边栏
          sortedKeywords.forEach(([keyword, count]) => {
            const tag = document.createElement("div");
            tag.className = "sidebar-tag-item";
            tag.innerHTML = `${keyword} <span class="tag-count">${count}</span>`;
            tag.dataset.keyword = keyword;

            // 如果该标签已被选中，添加active类
            if (selectedTags.has(keyword)) {
              tag.classList.add("active");
            }

            // 添加点击事件
            tag.addEventListener("click", () => {
              if (selectedTags.has(keyword)) {
                selectedTags.delete(keyword);
                tag.classList.remove("active");
              } else {
                selectedTags.add(keyword);
                tag.classList.add("active");
              }
              applyAllFilters();
            });

            sidebarTagsContainer.appendChild(tag);
          });
        }

        // 6. 填充期刊筛选器
        function populateJournalFilter(papers) {
          const journals = new Set();
          papers.forEach((paper) => {
            if (paper.journal) {
              journals.add(paper.journal);
            }
          });

          // 将期刊按字母顺序排序
          const sortedJournals = Array.from(journals).sort();

          // 获取搜索关键词
          const searchTerm = journalSearch.value.toLowerCase().trim();

          // 清空标签容器
          journalTagsContainer.innerHTML = "";

          // 添加期刊标签到侧边栏
          sortedJournals.forEach((journal) => {
            // 如果有搜索词，只显示匹配的期刊
            if (searchTerm && !journal.toLowerCase().includes(searchTerm)) {
              return;
            }

            const tag = document.createElement("div");
            tag.className = "sidebar-tag-item";
            tag.textContent = journal;
            tag.dataset.journal = journal;

            // 如果该期刊已被选中，添加active类
            if (selectedJournals.has(journal)) {
              tag.classList.add("active");
            }

            // 添加点击事件
            tag.addEventListener("click", () => {
              if (selectedJournals.has(journal)) {
                selectedJournals.delete(journal);
                tag.classList.remove("active");
              } else {
                selectedJournals.add(journal);
                tag.classList.add("active");
              }
              applyAllFilters();
            });

            journalTagsContainer.appendChild(tag);
          });
        }

        // 7. 填充来源筛选器
        function populateSourceFilter(papers) {
          const sources = new Set();
          papers.forEach((paper) => {
            if (paper.source) {
              // 统一转为小写存储
              sources.add(paper.source.toLowerCase());
            }
          });

          // 将来源按字母顺序排序
          const sortedSources = Array.from(sources).sort();

          // 获取搜索关键词
          const searchTerm = sourceSearch.value.toLowerCase().trim();

          // 清空标签容器
          sourceTagsContainer.innerHTML = "";

          // 添加来源标签到侧边栏
          sortedSources.forEach((source) => {
            // 如果有搜索词，只显示匹配的来源
            if (searchTerm && !source.toLowerCase().includes(searchTerm)) {
              return;
            }

            const tag = document.createElement("div");
            tag.className = "sidebar-tag-item";
            tag.textContent = source;
            tag.dataset.source = source;

            // 如果该来源已被选中，添加active类
            if (selectedSources.has(source)) {
              tag.classList.add("active");
            }

            // 添加点击事件
            tag.addEventListener("click", () => {
              if (selectedSources.has(source)) {
                selectedSources.delete(source);
                tag.classList.remove("active");
              } else {
                selectedSources.add(source);
                tag.classList.add("active");
              }
              applyAllFilters();
            });

            sourceTagsContainer.appendChild(tag);
          });
        }

        // 更新期刊标签显示
        function updateJournalTags() {
          document.querySelectorAll("#journal-tags-container .sidebar-tag-item").forEach((tag) => {
            if (selectedJournals.has(tag.dataset.journal)) {
              tag.classList.add("active");
            } else {
              tag.classList.remove("active");
            }
          });
        }

        // 更新来源标签显示
        function updateSourceTags() {
          document.querySelectorAll("#source-tags-container .sidebar-tag-item").forEach((tag) => {
            if (selectedSources.has(tag.dataset.source)) {
              tag.classList.add("active");
            } else {
              tag.classList.remove("active");
            }
          });
        }

        // 8. 时间筛选函数
        function filterByDate(papers) {
          const timeValue = currentTimeFilter;
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          let startDateValue, endDateValue;

          switch (timeValue) {
            case "today":
              startDateValue = new Date(today);
              endDateValue = new Date(today);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "week":
              startDateValue = new Date(today);
              // 计算到上周一的偏移量：如果今天是周日(0)，需要减去6天；其他情况减去(dayOfWeek-1)天
              const dayOfWeek = today.getDay(); // 0=周日, 1=周一, ..., 6=周六
              const daysToMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
              startDateValue.setDate(today.getDate() - daysToMonday);

              endDateValue = new Date(today);
              // 计算到本周日的偏移量：如果今天是周日(0)，不需要加；其他情况加上(7-dayOfWeek)天
              const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
              endDateValue.setDate(today.getDate() + daysToSunday);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "month":
              startDateValue = new Date(
                today.getFullYear(),
                today.getMonth(),
                1,
              );
              endDateValue = new Date(
                today.getFullYear(),
                today.getMonth() + 1,
                0,
              );
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "halfyear":
              startDateValue = new Date(today);
              startDateValue.setMonth(today.getMonth() - 6);
              endDateValue = new Date(today);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "year":
              startDateValue = new Date(today.getFullYear(), 0, 1);
              endDateValue = new Date(today.getFullYear(), 11, 31);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "2years":
              startDateValue = new Date(
                today.getFullYear() - 2,
                today.getMonth(),
                today.getDate(),
              );
              endDateValue = new Date(today);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "3years":
              startDateValue = new Date(
                today.getFullYear() - 3,
                today.getMonth(),
                today.getDate(),
              );
              endDateValue = new Date(today);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            case "5years":
              startDateValue = new Date(
                today.getFullYear() - 5,
                today.getMonth(),
                today.getDate(),
              );
              endDateValue = new Date(today);
              endDateValue.setHours(23, 59, 59, 999);
              break;
            default:
              return papers;
          }

          return papers.filter((paper) => {
            if (!paper.date) return true;

            const paperDateStr = paper.date;
            let paperDate;

            try {
              paperDate = new Date(paperDateStr);
            } catch (e) {
              return false;
            }

            return paperDate >= startDateValue && paperDate <= endDateValue;
          });
        }

        // 9. 期刊筛选函数（支持多选）
        function filterByJournal(papers) {
          // 如果没有选择任何期刊，返回所有论文
          if (selectedJournals.size === 0) return papers;
          
          // 返回包含任一选中期刊的论文
          return papers.filter((paper) => selectedJournals.has(paper.journal));
        }

        // 10. 来源筛选函数（支持多选和小写转换）
        function filterBySource(papers) {
          // 如果没有选择任何来源，返回所有论文
          if (selectedSources.size === 0) return papers;
          
          // 返回包含任一选中来源的论文（注意：论文中的来源需要转为小写进行比较）
          return papers.filter((paper) => paper.source && selectedSources.has(paper.source.toLowerCase()));
        }

        // 11. 关键词标签筛选函数
        function filterByKeywords(papers) {
          if (selectedTags.size === 0) return papers;

          return papers.filter((paper) => {
            if (
              !paper.ai ||
              !paper.ai.keywords ||
              !Array.isArray(paper.ai.keywords)
            ) {
              return false;
            }

            return Array.from(selectedTags).some((tag) =>
              paper.ai.keywords.includes(tag),
            );
          });
        }

        // 12. 搜索筛选函数（带防抖）
        function filterBySearch(papers) {
          const searchTerm = searchInput.value.toLowerCase().trim();
          if (!searchTerm) return papers;

          return papers.filter((paper) => {
            // 搜索标题
            const titleMatch =
              paper.title && paper.title.toLowerCase().includes(searchTerm);
            
            // 搜索摘要
            const abstractMatch =
              paper.abstract &&
              paper.abstract.toLowerCase().includes(searchTerm);
            
            // 搜索描述
            const descriptionMatch =
              paper.description &&
              paper.description.toLowerCase().includes(searchTerm);
            
            // 搜索AI信息中的TLDR
            const tldrMatch =
              paper.ai?.TLDR &&
              paper.ai.TLDR.toLowerCase().includes(searchTerm);
            
            // 搜索AI信息中的翻译
            const translationMatch =
              paper.ai?.translation &&
              paper.ai.translation.toLowerCase().includes(searchTerm);
            
            // 搜索关键词
            const keywordsMatch =
              paper.ai &&
              paper.ai.keywords &&
              Array.isArray(paper.ai.keywords) &&
              paper.ai.keywords.some((keyword) =>
                keyword.toLowerCase().includes(searchTerm),
              );

            return titleMatch || abstractMatch || descriptionMatch || tldrMatch || translationMatch || keywordsMatch;
          });
        }

        // 13. 应用所有筛选条件
        function applyAllFilters() {
          let filtered = [...allPapers];

          filtered = filterByDate(filtered);
          filtered = filterByJournal(filtered);
          filtered = filterBySource(filtered); // 添加来源筛选
          filtered = filterByKeywords(filtered);
          filtered = filterBySearch(filtered);

          filteredPapers = filtered;
          papersCount.textContent = filtered.length;
          currentPage = 1; // 重置到第一页
          renderPapersCards(container, filtered, currentPage);
        }

        // 14. 搜索防抖
        let searchTimeout;
        searchInput.addEventListener("input", () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            applyAllFilters();
          }, 300); // 300ms防抖
        });

        // 15. 事件监听器
        timeFilterButtons.addEventListener("click", (e) => {
          if (e.target.classList.contains("time-filter-btn")) {
            const value = e.target.dataset.value;
            currentTimeFilter = value;

            document.querySelectorAll(".time-filter-btn").forEach((btn) => {
              btn.classList.remove("active");
            });
            e.target.classList.add("active");

            applyAllFilters();
          }
        });

        // 初始化
        loadPapersData("data/llm_output.json")
          .then((papers) => {
            allPapers = papers;
            filteredPapers = papers;
            papersCount.textContent = papers.length;
            populateJournalFilter(papers);
            populateSidebarTags(papers);
            populateSourceFilter(papers);
            renderPapersCards(container, papers, currentPage);
          })
          .catch((error) => {
            console.error("加载论文时出错:", error);
            container.innerHTML = `<div class="loading" style='color: #d93025;'>加载论文失败: ${error.message}</div>`;
          });
      });
    </script>
  </body>
</html>